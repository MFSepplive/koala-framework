var path = require("path");
var loaderUtils = require("loader-utils");
var fs = require("fs");
var fetchComponentAssets = require("./fetch-component-assets-from-php");

module.exports = function(source, map) {

    var query = loaderUtils.parseQuery(this.query);

    if (!query.defer) {
        this.emitError("Missing loader parameter defer");
        return;
    }
    var loadDefer = query.defer == '1';

    if (!query.package) {
        this.emitError("Missing loader parameter package");
        return;
    }
    var package = query.package;

    this.cacheable();
    /*
    var callback = this.async();
    if (!callback) {
        this.emitError("Only async supported");
        return;
    }
    */

    var ret = '';
    if (!loadDefer) {
        var url = require.resolve('./component-assets-loader')+"?defer=1&package="+package+"!";
        ret += "require.ensure('"+url+"', function() { require('"+url+"'); });\n;";
    }

    var packageAssets = fetchComponentAssets();

    var cmps = packageAssets[package];
    for (var cmp in cmps) {
        var kwcClass = cmps[cmp].kwcClass;
        var kwcClassMaster = cmps[cmp].kwcClassMaster;
        cmps[cmp].files.forEach(function(asset) {
            var isMaster = !!asset.match(/Master(\.defer)?\.[a-z]+$/);
            var cls = isMaster ? kwcClassMaster : kwcClass;
            var isDeferredAsset = !!asset.match(/\.defer\.[a-z]+$/);
            if (isDeferredAsset == loadDefer) {
                if (asset.match(/\.scss$/)) {
                    ret += "require('"+require.resolve('./component-file-loader')+"?cls="+cls+"!"+require.resolve('./component-inject-class-loader')+"?cls="+cmp+"!./"+asset+"')\n";
                } else {
                    ret += "require('"+require.resolve('./component-file-loader')+"?cls="+cls+"!./"+asset+"');\n";
                }
            }
        }, this);
        var dep, files;
        if (!loadDefer) {
            dep = cmps[cmp].assets.dep;
            files = cmps[cmp].assets.files;
        } else {
            dep = cmps[cmp].assetsDefer.dep;
            files = cmps[cmp].assetsDefer.files;
        }
        dep.forEach(function(asset) {
            ret += "require('"+require.resolve('../loader/ini-loader')+"?dep="+asset+"!');\n";
        }, this);
        files.forEach(function(asset) {
            var isMaster = !!asset.match(/Master(\.defer)?\.[a-z]+$/);
            var cls = isMaster ? kwcClassMaster : kwcClass;
            ret += "require('"+require.resolve('./component-file-loader')+"?cls="+cls+"!"+require.resolve('./component-inject-class-loader')+"?cls="+cmp+"!"+asset+"');\n";
        }, this);
    }

    //callback(null, ret);
    return ret;
};
